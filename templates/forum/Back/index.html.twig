{% extends 'backoffice/layout.html.twig' %}

{% block page_title %}Liste des Forums{% endblock %}

{% block content %}
<div class="action-buttons">
    <a href="{{ path('app_back_forum_new') }}" class="btn btn-primary btn-action">
        <i class="bi bi-plus-circle"></i> Créer un nouveau forum
    </a>
    <a href="http://127.0.0.1:8000/front/forum" class="btn btn-success btn-action">
        <i class="bi bi-arrow-right-circle"></i> Go to Front
    </a>
</div>

<div class="table-container">
    <h3 class="mb-4">Liste des Forums</h3>
    
    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="input-group">
                <input type="text" id="searchTitle" class="form-control" placeholder="Rechercher par titre">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        <div class="col-md-3">
            <div class="input-group">
                <input type="text" id="searchCreator" class="form-control" placeholder="Rechercher par créateur">
            </div>
        </div>
        <div class="col-md-3">
            <select id="sortOrder" class="form-select">
                <option value="">Trier par date</option>
                <option value="asc">Date croissante</option>
                <option value="desc">Date décroissante</option>
            </select>
        </div>
        <div class="col-md-3">
            <button id="applyFilters" class="btn btn-primary">APPLIQUER</button>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="forumsTable">
            <thead class="table-dark">
                <tr>
                    <th>Id</th>
                    <th>Titre</th>
                    <th>Créateur</th>
                    <th>Date</th>
                    <th>État</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for forum in forums %}
                    <tr data-title="{{ forum.titre|lower }}" data-creator="{{ forum.createdBy ? forum.createdBy|lower : '' }}" data-date="{{ forum.dateCreation ? forum.dateCreation|date('Y-m-d') : '' }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ forum.titre }}</td>
                        <td>{{ forum.createdBy ? forum.createdBy }}</td>
                        <td>{{ forum.dateCreation ? forum.dateCreation|date('d/m/Y') : '' }}</td>
                        <td>
                            <span class="badge bg-{{ forum.etat == 'actif' ? 'success' : 'danger' }}">
                                {{ forum.etat }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ path('app_back_forum_edit', {'id': forum.id}) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form method="post" 
                                  action="{{ path('app_back_forum_delete', {'id': forum.id}) }}"
                                  onsubmit="return confirm('Voulez-vous vraiment supprimer ce forum ?');"
                                  style="display:inline;"
                                  data-turbo="false">
                                 <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ forum.id) }}">
                                 <button type="submit" class="btn btn-sm btn-outline-danger">
                                     <i class="bi bi-trash"></i>
                                 </button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted p-5">
                            Aucun forum trouvé.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchTitle');
    const searchCreatorInput = document.getElementById('searchCreator');
    const sortOrderSelect = document.getElementById('sortOrder');
    const applyBtn = document.getElementById('applyFilters');
    const searchBtn = document.getElementById('searchBtn');
    const tableBody = document.querySelector('#forumsTable tbody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    // Remove the "no results" row from sortable rows
    const sortableRows = rows.filter(row => !row.querySelector('td[colspan]'));
    
    function filterAndSort() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const searchCreatorTerm = searchCreatorInput.value.toLowerCase().trim();
        const sortOrder = sortOrderSelect.value;
        
        // Filter rows
        let filteredRows = sortableRows.filter(row => {
            const title = row.dataset.title;
            const creator = row.dataset.creator;
            
            const titleMatch = title.includes(searchTerm);
            const creatorMatch = creator.includes(searchCreatorTerm);
            
            return titleMatch && creatorMatch;
        });
        
        // Sort rows
        if (sortOrder === 'asc' || sortOrder === 'desc') {
            filteredRows.sort((a, b) => {
                const dateA = a.dataset.date ? new Date(a.dataset.date) : new Date('1970-01-01');
                const dateB = b.dataset.date ? new Date(b.dataset.date) : new Date('1970-01-01');
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
        }
        
        // Clear table
        tableBody.innerHTML = '';
        
        // Add filtered/sorted rows
        if (filteredRows.length > 0) {
            filteredRows.forEach(row => tableBody.appendChild(row));
        } else {
            // Show no results message
            const noResultsRow = document.createElement('tr');
            noResultsRow.innerHTML = '<td colspan="6" class="text-center text-muted p-5">Aucun forum trouvé.</td>';
            tableBody.appendChild(noResultsRow);
        }
    }
    
    // Event listeners
    applyBtn.addEventListener('click', filterAndSort);
    searchBtn.addEventListener('click', filterAndSort);
    
    // Allow search on Enter key
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            filterAndSort();
        }
    });
    
    searchCreatorInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            filterAndSort();
        }
    });
});
</script>
{% endblock %}

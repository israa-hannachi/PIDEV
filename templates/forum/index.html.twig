{% extends 'base.html.twig' %}

{% block title %}Liste des forums{% endblock %}

{% block stylesheets %}
<style>
    /* Titre plus visible */
    .page-title-container {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        margin-bottom: 10px;
    }
    .page-title-container h1 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: white;
    }

    /* Formulaire plus grand */
    #filter-form .form-control,
    #filter-form .form-select,
    #filter-form .btn {
        padding: 0.6rem 1rem;
        font-size: 1rem;
    }

    /* Tableau plus grand */
    .table.compact-table td,
    .table.compact-table th {
        padding: 0.8rem 1rem;
        font-size: 1rem;
        vertical-align: middle;
    }
    .table.compact-table th {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block body %}
<div class="page-title-container d-flex align-items-center"> 
  <!-- Logo supprimé -->
  <h1>Liste des Forums</h1> 
</div>

<a href="{{ path('forum_new') }}" class="btn btn-success mb-3">Créer un nouveau forum</a>

<form id="filter-form" class="d-flex mb-2">
    <input type="text" name="search" class="form-control form-control-sm me-2"
           placeholder="Rechercher par titre"
           value="{{ app.request.get('search') }}">

    <select name="creator" class="form-select form-select-sm me-2">
        <option value="">-- Créateur --</option>
        <option value="Farah Jemmali" {% if app.request.get('creator') == 'Farah Jemmali' %}selected{% endif %}>Farah Jemmali</option>
        <option value="Isra Dabbebi" {% if app.request.get('creator') == 'Isra Dabbebi' %}selected{% endif %}>Isra Dabbebi</option>
        <option value="Miriam Kouki" {% if app.request.get('creator') == 'Miriam Kouki' %}selected{% endif %}>Miriam Kouki</option>
    </select>

    <select name="date" class="form-select form-select-sm me-2">
        <option value="">-- Date --</option>
        <option value="today" {% if app.request.get('date') == 'today' %}selected{% endif %}>Aujourd'hui</option>
        <option value="week" {% if app.request.get('date') == 'week' %}selected{% endif %}>Cette semaine</option>
    </select>

    <select name="direction" class="form-select form-select-sm me-2">
        <option value="asc" {% if app.request.get('direction') == 'asc' %}selected{% endif %}>Date croissante</option>
        <option value="desc" {% if app.request.get('direction') == 'desc' %}selected{% endif %}>Date décroissante</option>
    </select>

    <button type="submit" class="btn btn-primary btn-sm">Appliquer</button>
</form>

<div id="forum-list" class="table-responsive">
    <table class="table table-sm table-striped table-hover compact-table">
        {% include 'forum/partials/_forum_list.html.twig' with { forums: forums } %}
    </table>
</div>

<script>
document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const button = this.querySelector('button[type="submit"]');
    const originalText = button.textContent;
    
    // Feedback immédiat
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Chargement...';
    
    const params = new URLSearchParams(new FormData(this));
    
    // Timeout pour éviter les requêtes trop longues
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    fetch('{{ path("app_forum_index") }}?' + params.toString(), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error('Erreur réseau');
        return response.text();
    })
    .then(html => {
        const forumListDiv = document.getElementById('forum-list');
        forumListDiv.innerHTML = '<table class="table table-sm table-striped table-hover compact-table">' + html + '</table>';
    })
    .catch(error => {
        console.error('Erreur:', error);
        if (error.name === 'AbortError') {
            alert('La requête a pris trop de temps. Veuillez réessayer.');
        } else {
            alert('Une erreur est survenue. Veuillez réessayer.');
        }
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
});

// Optimisation: appliquer le filtre automatiquement lors du changement
document.getElementById('filter-form').addEventListener('change', function(e) {
    if (e.target.tagName === 'SELECT' && e.target.value !== '') {
        // Déclencher le submit après un court délai pour éviter les clics multiples
        clearTimeout(this.filterTimeout);
        this.filterTimeout = setTimeout(() => {
            this.dispatchEvent(new Event('submit'));
        }, 300);
    }
});
</script>
{% endblock %}

